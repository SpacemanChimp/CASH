/* EVE Money Button - simple static frontend.
 * Loads docs/data/rankings.json (generated by GitHub Actions) and renders three tables.
 */

const state = {
  data: null,
};

function fmtISK(x) {
  if (x === null || x === undefined || Number.isNaN(x)) return "—";
  const n = Number(x);
  if (!Number.isFinite(n)) return "—";
  const abs = Math.abs(n);
  const sign = n < 0 ? "-" : "";
  const suffixes = [
    [1e12, "T"],
    [1e9, "B"],
    [1e6, "M"],
    [1e3, "K"],
  ];
  for (const [k, s] of suffixes) {
    if (abs >= k) return `${sign}${(abs / k).toFixed(2)}${s} ISK`;
  }
  return `${sign}${abs.toFixed(0)} ISK`;
}

function fmtPct(x) {
  if (x === null || x === undefined || Number.isNaN(x)) return "—";
  const n = Number(x);
  if (!Number.isFinite(n)) return "—";
  return `${(n * 100).toFixed(1)}%`;
}

function fmtM3(x) {
  if (x === null || x === undefined || Number.isNaN(x)) return "—";
  const n = Number(x);
  if (!Number.isFinite(n)) return "—";
  if (n >= 1000) return `${(n/1000).toFixed(2)}k m³`;
  return `${n.toFixed(2)} m³`;
}

function fmtDuration(seconds) {
  if (seconds === null || seconds === undefined || Number.isNaN(seconds)) return "—";
  const s0 = Number(seconds);
  if (!Number.isFinite(s0)) return "—";
  const s = Math.max(0, Math.floor(s0));
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  if (h > 0) return `${h}h ${m}m`;
  return `${m}m`;
}

function setStatus(msg) {
  const el = document.getElementById("status");
  el.textContent = msg;
}

// Sorting: most fields are "bigger is better" (desc).
// Payback (runs) is the opposite: smaller is better (asc), missing values go last.
function sortRows(rows, field) {
  const copy = [...rows];

  // Special-case payback: ascending, null/NaN => Infinity
  if (field === "payback_runs") {
    copy.sort((a, b) => {
      const avRaw = a[field];
      const bvRaw = b[field];
      const avNum = (avRaw === null || avRaw === undefined) ? Number.POSITIVE_INFINITY : Number(avRaw);
      const bvNum = (bvRaw === null || bvRaw === undefined) ? Number.POSITIVE_INFINITY : Number(bvRaw);
      const av = Number.isFinite(avNum) ? avNum : Number.POSITIVE_INFINITY;
      const bv = Number.isFinite(bvNum) ? bvNum : Number.POSITIVE_INFINITY;
      if (av !== bv) return av - bv; // asc
      // tie-breaker: higher ISK/hour wins
      const ap = Number(a.profit_per_hour || 0);
      const bp = Number(b.profit_per_hour || 0);
      return bp - ap;
    });
    return copy;
  }

  // Default: numeric desc; null/NaN last
  copy.sort((a, b) => {
    const av = Number(a[field]);
    const bv = Number(b[field]);

    const aOk = Number.isFinite(av);
    const bOk = Number.isFinite(bv);

    if (!aOk && !bOk) return 0;
    if (!aOk) return 1;
    if (!bOk) return -1;

    return bv - av;
  });

  return copy;
}

function renderMaterialsDetails(entry) {
  const d = document.createElement("details");
  d.className = "materials";
  const s = document.createElement("summary");
  s.textContent = "Materials / Breakdown";
  d.appendChild(s);

  const wrap = document.createElement("div");
  wrap.className = "small";
  wrap.innerHTML = `
    <div><span class="badge">Cost</span> ${fmtISK(entry.cost)} &nbsp; <span class="badge">Revenue</span> ${fmtISK(entry.revenue)} &nbsp; <span class="badge">Fees</span> ${fmtISK(entry.fees || 0)}</div>
  `;
  d.appendChild(wrap);

  if (entry.materials && entry.materials.length) {
    const ul = document.createElement("ul");
    ul.className = "materialList";
    for (const m of entry.materials) {
      const li = document.createElement("li");
      li.textContent = `${m.name} × ${m.qty} @ ${fmtISK(m.unit_price)} = ${fmtISK(m.extended)}`;
      ul.appendChild(li);
    }
    d.appendChild(ul);
  } else {
    const p = document.createElement("div");
    p.className = "small";
    p.textContent = "No material breakdown available.";
    d.appendChild(p);
  }

  return d;
}

function renderTable(containerId, rows, columns, detailsFn) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";

  if (!rows || !rows.length) {
    container.innerHTML = `<div class="card small">No rows.</div>`;
    return;
  }

  const table = document.createElement("table");
  const thead = document.createElement("thead");
  const trh = document.createElement("tr");
  for (const c of columns) {
    const th = document.createElement("th");
    th.textContent = c.title;
    trh.appendChild(th);
  }
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  for (const r of rows) {
    const tr = document.createElement("tr");
    for (const c of columns) {
      const td = document.createElement("td");
      td.innerHTML = c.render(r);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);

    if (detailsFn) {
      const tr2 = document.createElement("tr");
      const td2 = document.createElement("td");
      td2.colSpan = columns.length;
      td2.appendChild(detailsFn(r));
      tr2.appendChild(td2);
      tbody.appendChild(tr2);
    }
  }
  table.appendChild(tbody);
  container.appendChild(table);
}

function renderAll() {
  const data = state.data;
  if (!data) return;

  const gen = data.generated_at ? new Date(data.generated_at).toISOString() : "unknown";
  const market = data.market || {};
  setStatus(`Loaded. Generated: ${gen} | Region: ${market.region_id ?? "?"} | Station: ${market.station_id ?? "—"} | Scope: ${market.pricing_scope ?? "?"} | Price mode: ${data.assumptions?.price_mode ?? "?"}`);

  // Manufacturing
  const mfgSort = document.getElementById("mfgSort").value;
  const mfgRows = sortRows(data.manufacturing || [], mfgSort);

  renderTable("mfgTable", mfgRows, [
    { title: "Build (Product)", render: (r) => `<div><strong>${r.product_name}</strong></div><div class="small">${r.blueprint_name}</div>` },
    { title: "Profit/run", render: (r) => `<span class="${r.profit >= 0 ? "pos":"neg"}">${fmtISK(r.profit)}</span>` },
    { title: "ISK/hour", render: (r) => `<span class="${r.profit_per_hour >= 0 ? "pos":"neg"}">${fmtISK(r.profit_per_hour)}</span>` },
    { title: "ROI", render: (r) => `${fmtPct(r.roi)}` },
    { title: "Time", render: (r) => `${fmtDuration(r.time_s)}` },
    { title: "Cost", render: (r) => `${fmtISK(r.cost)}` },
    { title: "BPO cost", render: (r) => `${fmtISK(r.blueprint_cost)}` },
    { title: "Payback (runs)", render: (r) => `${(r.payback_runs === null || r.payback_runs === undefined || !Number.isFinite(Number(r.payback_runs))) ? "—" : Number(r.payback_runs).toFixed(1)}` },
  ], renderMaterialsDetails);

  // Reactions
  const rxSort = document.getElementById("rxSort").value;
  const rxRows = sortRows(data.reactions || [], rxSort);

  renderTable("rxTable", rxRows, [
    { title: "Reaction (Output)", render: (r) => `<div><strong>${r.product_name}</strong></div><div class="small">${r.blueprint_name}</div>` },
    { title: "Profit/run", render: (r) => `<span class="${r.profit >= 0 ? "pos":"neg"}">${fmtISK(r.profit)}</span>` },
    { title: "ISK/hour", render: (r) => `<span class="${r.profit_per_hour >= 0 ? "pos":"neg"}">${fmtISK(r.profit_per_hour)}</span>` },
    { title: "ROI", render: (r) => `${fmtPct(r.roi)}` },
    { title: "Time", render: (r) => `${fmtDuration(r.time_s)}` },
    { title: "Cost", render: (r) => `${fmtISK(r.cost)}` },
    { title: "Formula cost", render: (r) => `${fmtISK(r.blueprint_cost)}` },
  ], renderMaterialsDetails);

  // Refining
  const refSort = document.getElementById("refSort").value;
  const refRows = sortRows(data.refining || [], refSort);

  renderTable("refTable", refRows, [
    { title: "Reprocess this", render: (r) => `<div><strong>${r.input_name}</strong></div><div class="small">Batch: ${r.batch_units} units (${fmtM3(r.batch_m3)})</div>` },
    { title: "ISK/m³", render: (r) => `<span class="${r.profit_per_m3 >= 0 ? "pos":"neg"}">${fmtISK(r.profit_per_m3)}</span>` },
    { title: "Profit/batch", render: (r) => `<span class="${r.profit >= 0 ? "pos":"neg"}">${fmtISK(r.profit)}</span>` },
    { title: "ROI", render: (r) => `${fmtPct(r.roi)}` },
    { title: "Input cost", render: (r) => `${fmtISK(r.cost)}` },
    { title: "Output value", render: (r) => `${fmtISK(r.revenue)}` },
  ], renderMaterialsDetails);
}

async function loadData() {
  try {
    setStatus("Loading data/rankings.json …");
    const cacheBust = `cb=${Date.now()}`;
    const res = await fetch(`data/rankings.json?${cacheBust}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    state.data = data;
    renderAll();
  } catch (err) {
    console.error(err);
    setStatus(`Failed to load rankings.json: ${err}`);
  }
}

function setupTabs() {
  const tabs = document.querySelectorAll(".tab");
  tabs.forEach(t => {
    t.addEventListener("click", () => {
      tabs.forEach(x => x.classList.remove("active"));
      t.classList.add("active");

      const id = t.getAttribute("data-tab");
      document.querySelectorAll(".tabPanel").forEach(p => p.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    });
  });
}

function setupSorters() {
  ["mfgSort","rxSort","refSort"].forEach(id => {
    document.getElementById(id).addEventListener("change", () => renderAll());
  });
}

document.getElementById("runBtn").addEventListener("click", loadData);
document.getElementById("reloadBtn").addEventListener("click", loadData);

setupTabs();
setupSorters();

// Auto-load on page open (so “press button” is optional)
loadData();
